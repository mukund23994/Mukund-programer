<!DOCTYPE html>
<html>
<head>
  <title>My Store - Add to Cart</title>
</head>
<body>
  <h1>My Products</h1>

  <div id="products"></div>

  <h2>Your Cart</h2>
  <div id="cart"></div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore-compat.js"></script>

  <script>
    // ===== Firebase Config =====
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_PROJECT_ID.appspot.com",
      messagingSenderId: "SENDER_ID",
      appId: "APP_ID"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // ===== Sample Products =====
    const sampleProducts = [
      {id: "1", name: "Product 1", price: 499},
      {id: "2", name: "Product 2", price: 299},
      {id: "3", name: "Product 3", price: 199}
    ];

    const productsDiv = document.getElementById("products");
    const cartDiv = document.getElementById("cart");

    // Display products
    sampleProducts.forEach(product => {
      const productEl = document.createElement("div");
      productEl.innerHTML = `
        <h3>${product.name}</h3>
        <p>Price: ₹${product.price}</p>
        <button onclick="addToCart('${product.id}', '${product.name}', ${product.price})">Add to Cart</button>
      `;
      productsDiv.appendChild(productEl);
    });

    // ===== Add to Cart Function =====
    async function addToCart(id, name, price) {
      const user = auth.currentUser;
      if (!user) {
        alert("Please login first!");
        return;
      }

      const cartRef = db.collection("carts").doc(user.uid);

      const cartDoc = await cartRef.get();
      if (cartDoc.exists) {
        let cartData = cartDoc.data();
        // Check if product already in cart
        const index = cartData.products.findIndex(p => p.id === id);
        if (index !== -1) {
          cartData.products[index].quantity += 1;
        } else {
          cartData.products.push({id, name, price, quantity: 1});
        }
        await cartRef.set(cartData);
      } else {
        await cartRef.set({
          products: [{id, name, price, quantity: 1}]
        });
      }
      alert(name + " added to cart!");
      displayCart();
    }

    // ===== Display Cart =====
    async function displayCart() {
      const user = auth.currentUser;
      if (!user) {
        cartDiv.innerHTML = "Login to see your cart.";
        return;
      }

      const cartDoc = await db.collection("carts").doc(user.uid).get();
      if (!cartDoc.exists) {
        cartDiv.innerHTML = "Cart is empty.";
        return;
      }

      const cartData = cartDoc.data();
      cartDiv.innerHTML = "";
      let total = 0;

      cartData.products.forEach(p => {
        const pEl = document.createElement("div");
        pEl.innerHTML = `${p.name} - ₹${p.price} x ${p.quantity}`;
        cartDiv.appendChild(pEl);
        total += p.price * p.quantity;
      });

      const totalEl = document.createElement("h3");
      totalEl.innerHTML = `Total: ₹${total}`;
      cartDiv.appendChild(totalEl);
    }

    // ===== Check user login status =====
    auth.onAuthStateChanged(user => {
      if (user) {
        console.log("Logged in as: ", user.uid);
        displayCart();
      } else {
        console.log("No user logged in");
        cartDiv.innerHTML = "Login to see your cart.";
      }
    });
  </script>
</body>
</html>
